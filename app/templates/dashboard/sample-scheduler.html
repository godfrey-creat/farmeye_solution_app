{% extends "base.html" %}

{% block title %}Task Scheduler - FarmEye{% endblock %}

{% block head %}
<!-- Task Management CSS -->
<link rel="stylesheet" href="{{ url_for('static', filename='css/components/calendar.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/components/task-forms.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/components/task-integration.css') }}">

<!-- Chart.js for analytics -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
{% endblock %}

{% block content %}
<div class="dashboard-container">
    <!-- Page Header -->
    <div class="page-header">
        <div class="header-content">
            <h1 class="page-title">
                <i class="fas fa-calendar-alt"></i>
                Task Scheduler
            </h1>
            <p class="page-description">Plan, track, and manage your farming activities</p>
        </div>
        
        <div class="header-actions">
            <button class="btn-secondary" onclick="showTaskAnalytics()">
                <i class="fas fa-chart-bar"></i>
                Analytics
            </button>
            <button class="btn-primary" onclick="taskManager.createTask()">
                <i class="fas fa-plus"></i>
                Add Task
            </button>
        </div>
    </div>
    
    <!-- Quick Stats -->
    <div class="quick-stats" id="task-quick-stats">
        <div class="stat-card pending">
            <div class="stat-icon">
                <i class="fas fa-clock"></i>
            </div>
            <div class="stat-content">
                <h3 id="pending-count">0</h3>
                <p>Pending Tasks</p>
            </div>
        </div>
        
        <div class="stat-card in-progress">
            <div class="stat-icon">
                <i class="fas fa-play"></i>
            </div>
            <div class="stat-content">
                <h3 id="in-progress-count">0</h3>
                <p>In Progress</p>
            </div>
        </div>
        
        <div class="stat-card completed">
            <div class="stat-icon">
                <i class="fas fa-check"></i>
            </div>
            <div class="stat-content">
                <h3 id="completed-count">0</h3>
                <p>Completed</p>
            </div>
        </div>
        
        <div class="stat-card due-today">
            <div class="stat-icon">
                <i class="fas fa-calendar-day"></i>
            </div>
            <div class="stat-content">
                <h3 id="due-today-count">0</h3>
                <p>Due Today</p>
            </div>
        </div>
    </div>
    
    <!-- Main Calendar -->
    <div class="main-content">
        <div class="calendar-section">
            <div id="task-calendar" class="task-calendar-container">
                <!-- Calendar will be rendered here by JavaScript -->
            </div>
        </div>
        
        <!-- Sidebar -->
        <div class="sidebar-section">
            <!-- Upcoming Tasks -->
            <div class="sidebar-widget">
                <div class="widget-header">
                    <h3>Upcoming Tasks</h3>
                    <button class="btn-icon" onclick="taskManager.createTask()">
                        <i class="fas fa-plus"></i>
                    </button>
                </div>
                <div class="widget-content">
                    <div id="upcoming-tasks-list" class="upcoming-tasks">
                        <!-- Upcoming tasks will be loaded here -->
                    </div>
                </div>
            </div>
            
            <!-- Weather Forecast -->
            <div class="sidebar-widget">
                <div class="widget-header">
                    <h3>Weather Forecast</h3>
                    <button class="btn-icon" onclick="refreshWeather()">
                        <i class="fas fa-sync"></i>
                    </button>
                </div>
                <div class="widget-content">
                    <div id="weather-forecast" class="weather-forecast">
                        <!-- Weather forecast will be loaded here -->
                    </div>
                </div>
            </div>
            
            <!-- Growth Stages -->
            <div class="sidebar-widget">
                <div class="widget-header">
                    <h3>Current Growth Stages</h3>
                </div>
                <div class="widget-content">
                    <div id="growth-stages-list" class="growth-stages">
                        <!-- Growth stages will be loaded here -->
                    </div>
                </div>
            </div>
            
            <!-- Task Categories -->
            <div class="sidebar-widget">
                <div class="widget-header">
                    <h3>Task Categories</h3>
                </div>
                <div class="widget-content">
                    <div id="task-categories-legend" class="categories-legend">
                        <!-- Categories will be loaded here -->
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Loading Overlay -->
<div id="loading-overlay" class="loading-overlay" style="display: none;">
    <div class="loading-spinner">
        <i class="fas fa-spinner fa-spin"></i>
        <p>Loading tasks...</p>
    </div>
</div>

<!-- Notification Container -->
<div id="notification-container" class="notification-container"></div>
{% endblock %}

{% block scripts %}
<!-- Task Management JavaScript -->
<script type="module" src="{{ url_for('static', filename='js/task-init.js') }}"></script>

<script>
// Global functions for template
window.showTaskAnalytics = function() {
    if (window.taskAnalytics) {
        const modal = document.createElement('div');
        modal.className = 'modal-overlay';
        modal.innerHTML = `
            <div class="modal-container analytics-modal">
                <div class="modal-header">
                    <h3>Task Analytics</h3>
                    <button class="btn-close" onclick="this.closest('.modal-overlay').remove()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <div id="analytics-dashboard" style="height: 600px;"></div>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
        
        // Initialize analytics in modal
        import('./static/js/modules/task-analytics.js').then(({ default: TaskAnalytics }) => {
            new TaskAnalytics('analytics-dashboard');
        });
    }
};

window.refreshWeather = function() {
    if (window.store && window.store.weather) {
        window.store.weather.fetchWeatherForecast();
        window.store.weather.fetchCurrentWeather();
    }
};

// Initialize page-specific functionality
document.addEventListener('DOMContentLoaded', function() {
    // Update quick stats when store updates
    if (window.store) {
        window.store.subscribe(action => {
            if (action.type === 'TASK_STATISTICS_LOADED') {
                updateQuickStats(action.payload);
            }
            
            if (action.type === 'UPCOMING_TASKS_LOADED') {
                updateUpcomingTasksList(action.payload);
            }
            
            if (action.type === 'WEATHER_FORECAST_LOADED') {
                updateWeatherForecast(action.payload);
            }
            
            if (action.type === 'GROWTH_STAGES_LOADED') {
                updateGrowthStagesList(action.payload);
            }
            
            if (action.type === 'TASK_CATEGORIES_LOADED') {
                updateCategoriesLegend(action.payload);
            }
        });
    }
});

function updateQuickStats(statistics) {
    if (!statistics || !statistics.counts) return;
    
    const counts = statistics.counts;
    document.getElementById('pending-count').textContent = counts.pending || 0;
    document.getElementById('in-progress-count').textContent = counts.in_progress || 0;
    document.getElementById('completed-count').textContent = counts.completed || 0;
    document.getElementById('due-today-count').textContent = counts.due_today || 0;
}

function updateUpcomingTasksList(tasks) {
    const container = document.getElementById('upcoming-tasks-list');
    
    if (!tasks || tasks.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <i class="fas fa-calendar-check"></i>
                <p>No upcoming tasks</p>
            </div>
        `;
        return;
    }
    
    container.innerHTML = tasks.slice(0, 5).map(task => `
        <div class="upcoming-task-item" onclick="window.taskManager?.editTask(${task.id})">
            <div class="task-indicator status-${task.status}"></div>
            <div class="task-content">
                <div class="task-title">${task.title}</div>
                <div class="task-meta">
                    <span class="task-date">${new Date(task.start_date).toLocaleDateString()}</span>
                    <span class="task-type">${task.task_type}</span>
                </div>
            </div>
        </div>
    `).join('');
}

function updateWeatherForecast(forecast) {
    const container = document.getElementById('weather-forecast');
    
    if (!forecast || forecast.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <i class="fas fa-cloud"></i>
                <p>Weather data unavailable</p>
            </div>
        `;
        return;
    }
    
    container.innerHTML = forecast.slice(0, 5).map(day => `
        <div class="weather-day">
            <div class="weather-date">${new Date(day.date).toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' })}</div>
            <div class="weather-icon">
                <i class="fas fa-${getWeatherIcon(day.conditions)}"></i>
            </div>
            <div class="weather-temp">${Math.round(day.temperature)}Â°C</div>
            <div class="weather-condition">${day.conditions}</div>
            ${day.precipitation_probability > 30 ? `<div class="weather-rain"><i class="fas fa-tint"></i> ${day.precipitation_probability}%</div>` : ''}
        </div>
    `).join('');
}

function updateGrowthStagesList(stages) {
    const container = document.getElementById('growth-stages-list');
    
    if (!stages || stages.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <i class="fas fa-seedling"></i>
                <p>No active growth stages</p>
            </div>
        `;
        return;
    }
    
    const currentDate = new Date();
    const activeStages = stages.filter(stage => {
        const startDate = new Date(stage.start_date);
        const endDate = stage.end_date ? new Date(stage.end_date) : new Date('9999-12-31');
        return currentDate >= startDate && currentDate <= endDate;
    });
    
    container.innerHTML = activeStages.map(stage => `
        <div class="growth-stage-item">
            <div class="stage-header">
                <h4>${stage.stage_name}</h4>
                <span class="stage-farm">Farm ${stage.farm_id}</span>
            </div>
            <div class="stage-dates">
                ${new Date(stage.start_date).toLocaleDateString()} - 
                ${stage.end_date ? new Date(stage.end_date).toLocaleDateString() : 'Ongoing'}
            </div>
            ${stage.notes ? `<p class="stage-notes">${stage.notes}</p>` : ''}
        </div>
    `).join('');
}

function updateCategoriesLegend(categories) {
    const container = document.getElementById('task-categories-legend');
    
    container.innerHTML = categories.map(category => `
        <div class="category-item">
            <div class="category-color" style="background-color: ${category.color}"></div>
            <span class="category-name">${category.name}</span>
        </div>
    `).join('');
}

function getWeatherIcon(condition) {
    const icons = {
        'Clear': 'sun',
        'Clouds': 'cloud',
        'Rain': 'cloud-rain',
        'Snow': 'snowflake',
        'Thunderstorm': 'bolt',
        'Drizzle': 'cloud-drizzle'
    };
    return icons[condition] || 'cloud';
}
</script>

<style>
/* Page-specific styles */
.dashboard-container {
    padding: 24px;
    max-width: 1400px;
    margin: 0 auto;
}

.page-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 24px;
    flex-wrap: wrap;
    gap: 16px;
}

.header-content h1 {
    margin: 0 0 8px 0;
    color: #2d3748;
    font-size: 28px;
    font-weight: 600;
}

.header-content p {
    margin: 0;
    color: #718096;
    font-size: 16px;
}

.header-actions {
    display: flex;
    gap: 12px;
}

.quick-stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin-bottom: 32px;
}

.stat-card {
    background: white;
    border-radius: 12px;
    padding: 24px;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    display: flex;
    align-items: center;
    gap: 16px;
}

.stat-icon {
    width: 48px;
    height: 48px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 20px;
    color: white;
}

.stat-card.pending .stat-icon { background: #ffc107; }
.stat-card.in-progress .stat-icon { background: #17a2b8; }
.stat-card.completed .stat-icon { background: #28a745; }
.stat-card.due-today .stat-icon { background: #dc3545; }

.stat-content h3 {
    margin: 0 0 4px 0;
    font-size: 24px;
    font-weight: 700;
    color: #2d3748;
}

.stat-content p {
    margin: 0;
    color: #718096;
    font-size: 14px;
}

.main-content {
    display: grid;
    grid-template-columns: 1fr 320px;
    gap: 24px;
}

.calendar-section {
    background: white;
    border-radius: 12px;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    overflow: hidden;
}

.sidebar-section {
    display: flex;
    flex-direction: column;
    gap: 20px;
}

.sidebar-widget {
    background: white;
    border-radius: 12px;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    overflow: hidden;
}

.widget-header {
    padding: 16px 20px;
    border-bottom: 1px solid #e9ecef;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.widget-header h3 {
    margin: 0;
    font-size: 16px;
    font-weight: 600;
    color: #2d3748;
}

.widget-content {
    padding: 16px 20px;
}

.upcoming-task-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px 0;
    border-bottom: 1px solid #f7fafc;
    cursor: pointer;
    transition: background 0.2s ease;
}

.upcoming-task-item:hover {
    background: #f7fafc;
    margin: 0 -20px;
    padding-left: 20px;
    padding-right: 20px;
}

.upcoming-task-item:last-child {
    border-bottom: none;
}

.task-indicator {
    width: 4px;
    height: 32px;
    border-radius: 2px;
}

.task-indicator.status-pending { background: #ffc107; }
.task-indicator.status-in_progress { background: #17a2b8; }
.task-indicator.status-completed { background: #28a745; }

.task-title {
    font-weight: 500;
    color: #2d3748;
    margin-bottom: 4px;
}

.task-meta {
    display: flex;
    gap: 12px;
    font-size: 12px;
    color: #718096;
}

.weather-day {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 8px 0;
    border-bottom: 1px solid #f7fafc;
}

.weather-day:last-child {
    border-bottom: none;
}

.weather-icon {
    color: #ffc107;
}

.growth-stage-item {
    padding: 12px 0;
    border-bottom: 1px solid #f7fafc;
}

.growth-stage-item:last-child {
    border-bottom: none;
}

.stage-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 4px;
}

.stage-header h4 {
    margin: 0;
    font-size: 14px;
    font-weight: 600;
    color: #2d3748;
}

.stage-farm {
    font-size: 12px;
    color: #718096;
}

.stage-dates {
    font-size: 12px;
    color: #718096;
    margin-bottom: 4px;
}

.stage-notes {
    font-size: 12px;
    color: #4a5568;
    margin: 0;
}

.category-item {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 4px 0;
}

.category-color {
    width: 12px;
    height: 12px;
    border-radius: 2px;
}

.category-name {
    font-size: 14px;
    color: #2d3748;
}

.empty-state {
    text-align: center;
    padding: 20px;
    color: #718096;
}

.empty-state i {
    font-size: 24px;
    margin-bottom: 8px;
    opacity: 0.5;
}

.loading-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(255, 255, 255, 0.9);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 9999;
}

.loading-spinner {
    text-align: center;
    color: #718096;
}

.loading-spinner i {
    font-size: 32px;
    margin-bottom: 16px;
}

@media (max-width: 768px) {
    .main-content {
        grid-template-columns: 1fr;
    }
    
    .page-header {
        flex-direction: column;
        align-items: stretch;
    }
    
    .header-actions {
        justify-content: center;
    }
    
    .quick-stats {
        grid-template-columns: repeat(2, 1fr);
    }
}

@media (max-width: 480px) {
    .quick-stats {
        grid-template-columns: 1fr;
    }
    
    .dashboard-container {
        padding: 16px;
    }
}
</style>
{% endblock %}