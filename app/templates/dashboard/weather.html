{% extends "base.html" %} {% block title %}FarmEye - Weather Dashboard{%
endblock %} {% block extra_css %}
<style>
  .weather-gradient {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  }

  .weather-card {
    transition: all 0.3s ease;
    backdrop-filter: blur(10px);
  }

  .weather-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
  }

  .weather-icon {
    filter: drop-shadow(2px 4px 6px rgba(0, 0, 0, 0.1));
  }

  .forecast-scroll {
    scrollbar-width: thin;
    scrollbar-color: #cbd5e0 #f7fafc;
  }

  .forecast-scroll::-webkit-scrollbar {
    height: 6px;
  }

  .forecast-scroll::-webkit-scrollbar-track {
    background: #f7fafc;
    border-radius: 3px;
  }

  .forecast-scroll::-webkit-scrollbar-thumb {
    background: #cbd5e0;
    border-radius: 3px;
  }

  .wind-direction {
    animation: sway 3s ease-in-out infinite;
  }

  @keyframes sway {
    0%,
    100% {
      transform: rotate(-5deg);
    }
    50% {
      transform: rotate(5deg);
    }
  }
</style>
{% endblock %} {% block content %}
<!-- Location Header -->
<div class="bg-white rounded-xl shadow-lg p-6 mb-6">
  <div class="flex items-center justify-between">
    <div class="flex items-center space-x-4">
      <div
        class="w-16 h-16 bg-primary rounded-full flex items-center justify-center"
      >
        <i class="fas fa-map-marked-alt text-white text-2xl"></i>
      </div>
      <div>
        <h1 class="text-2xl font-bold text-gray-800">{{ farm.name }}</h1>
        <p class="text-gray-600">
          <i class="fas fa-location-dot text-primary mr-1"></i>
          Location: {{ location_name|default(farm.location) }}{% if farm.region %}, {{ farm.region|title }}{% endif %}
        </p>
      </div>
    </div>
    <div class="text-right">
      <p class="text-sm text-gray-500">Last updated</p>
      <p class="text-lg font-semibold text-gray-800" id="last-update">
        <span id="current-time"></span>

        <script>
          function updateCurrentTime() {
            const now = new Date();
            const hours = now.getHours();
            const minutes = now.getMinutes();
            const ampm = hours >= 12 ? "PM" : "AM";
            const displayHours = hours % 12 || 12;
            const displayMinutes = minutes < 10 ? "0" + minutes : minutes;

            document.getElementById(
              "current-time"
            ).textContent = `${displayHours}:${displayMinutes} ${ampm}`;
          }

          // Update immediately
          updateCurrentTime();

          // Update every minute
          setInterval(updateCurrentTime, 60000);
        </script>
      </p>
      <div class="flex space-x-2">
        <button
          onclick="refreshWeather()"
          class="mt-2 px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary-dark transition-colors"
        >
          <i class="fas fa-sync-alt mr-2"></i>Refresh
        </button>
        <button
          onclick="showSearchModal()"
          class="mt-2 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors"
        >
          <i class="fas fa-search mr-2"></i>Search
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Search Location Modal -->
<div id="searchModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
  <div class="bg-white rounded-lg p-6 w-full max-w-md">
    <h3 class="text-xl font-bold mb-4">Search Location</h3>
    <div class="mb-4">
      <input type="text" id="locationSearch" placeholder="Enter city or location name" 
             class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary">
    </div>
    <div class="flex justify-end space-x-2">
      <button onclick="closeSearchModal()" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300">
        Cancel
      </button>
      <button onclick="searchLocation()" class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary-dark">
        Search
      </button>
    </div>
  </div>
</div>

{% if not has_location %}
<!-- No Location Message -->
<div class="bg-white rounded-xl p-8 shadow-lg text-center">
  <i class="fas fa-map-marker-alt text-6xl text-gray-400 mb-4"></i>
  <h2 class="text-2xl font-semibold mb-2">Location Required</h2>
  <p class="text-gray-600 mb-6">
    Please update your farm location to view weather data.
  </p>
  <a
    href="{{ url_for('farm.edit_farm', farm_id=farm.id) }}"
    class="inline-block px-6 py-3 bg-primary text-white rounded-lg hover:bg-primary-dark transition-colors"
  >
    <i class="fas fa-edit mr-2"></i>Update Farm Location
  </a>
</div>

{% elif error %}
<!-- Error State -->
<div class="bg-white rounded-xl p-8 shadow-lg text-center">
  <i class="fas fa-exclamation-circle text-6xl text-red-500 mb-4"></i>
  <h2 class="text-2xl font-semibold mb-2">Weather Data Unavailable</h2>
  <p class="text-gray-600 mb-6">
    Unable to fetch weather data. Please try again.
  </p>
  <button
    onclick="location.reload()"
    class="px-6 py-3 bg-primary text-white rounded-lg hover:bg-primary-dark transition-colors"
  >
    <i class="fas fa-redo mr-2"></i>Try Again
  </button>
</div>

{% else %}
<!-- Current Weather -->
<div class="weather-gradient rounded-xl p-6 mb-6 text-white">
  <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
    <!-- Main Weather Display -->
    <div class="flex items-center justify-between">
      <div>
        <h2 class="text-3xl font-bold mb-2">Current Weather</h2>
        <p class="text-5xl font-bold mb-2">{{ current.temp }}°C</p>
        <p class="text-xl mb-1">{{ current.description|title }}</p>
        <p class="text-lg opacity-90">Feels like {{ current.feels_like }}°C</p>
        <div class="flex items-center mt-4 space-x-4">
          <div>
            <i class="fas fa-wind mr-1"></i>
            {{ current.wind_speed }} km/h
          </div>
          <div>
            <i class="fas fa-tint mr-1"></i>
            {{ current.humidity }}%
          </div>
          <div>
            <i class="fas fa-eye mr-1"></i>
            {{ current.visibility }} km
          </div>
        </div>
      </div>
      <div class="text-center">
        <img
          src="https://openweathermap.org/img/wn/{{ current.icon }}@4x.png"
          alt="{{ current.description }}"
          class="weather-icon w-40 h-40 mx-auto"
        />
        <div class="mt-4 grid grid-cols-2 gap-4 text-sm">
          <div>
            <i class="fas fa-sunrise text-yellow-300"></i>
            {{ current.sunrise.strftime('%I:%M %p') }}
          </div>
          <div>
            <i class="fas fa-sunset text-orange-400"></i>
            {{ current.sunset.strftime('%I:%M %p') }}
          </div>
        </div>
      </div>
    </div>

    <!-- Weather Stats Grid -->
    <div class="grid grid-cols-2 gap-4">
      <div class="bg-white bg-opacity-20 rounded-lg p-4">
        <div class="flex items-center justify-between mb-2">
          <span class="text-sm opacity-90">UV Index</span>
          <i class="fas fa-sun text-yellow-300"></i>
        </div>
        <p class="text-2xl font-bold">{{ current.uvi }}</p>
        <p class="text-sm opacity-90">
          {% if current.uvi < 3 %}Low {% elif current.uvi < 6 %}Moderate {% elif
          current.uvi < 8 %}High {% elif current.uvi < 11 %}Very High {% else
          %}Extreme {% endif %}
        </p>
      </div>

      <div class="bg-white bg-opacity-20 rounded-lg p-4">
        <div class="flex items-center justify-between mb-2">
          <span class="text-sm opacity-90">Pressure</span>
          <i class="fas fa-compress-arrows-alt"></i>
        </div>
        <p class="text-2xl font-bold">{{ current.pressure }}</p>
        <p class="text-sm opacity-90">hPa</p>
      </div>

      <div class="bg-white bg-opacity-20 rounded-lg p-4">
        <div class="flex items-center justify-between mb-2">
          <span class="text-sm opacity-90">Dew Point</span>
          <i class="fas fa-temperature-low"></i>
        </div>
        <p class="text-2xl font-bold">{{ current.dew_point }}°C</p>
        <p class="text-sm opacity-90">Comfort level</p>
      </div>

      <div class="bg-white bg-opacity-20 rounded-lg p-4">
        <div class="flex items-center justify-between mb-2">
          <span class="text-sm opacity-90">Wind</span>
          <i
            class="fas fa-compass wind-direction"
            style="transform: rotate({{ current.wind_deg }}deg)"
          ></i>
        </div>
        <p class="text-2xl font-bold">{{ current.wind_speed }}</p>
        <p class="text-sm opacity-90">
          km/h {{ wind_direction(current.wind_deg) }}
        </p>
      </div>
    </div>
  </div>
</div>

<!-- Weather Alerts -->
{% if alerts %}
<div class="bg-red-50 border-l-4 border-red-500 rounded-lg p-4 mb-6">
  <div class="flex items-start">
    <i class="fas fa-exclamation-triangle text-red-500 text-xl mr-3 mt-1"></i>
    <div>
      <h3 class="text-lg font-semibold text-red-800">Weather Alert</h3>
      {% for alert in alerts %}
      <p class="text-red-700 mt-1">
        {{ alert.event }}: {{ alert.description }}
      </p>
      {% endfor %}
    </div>
  </div>
</div>
{% endif %}

<!-- Hourly Forecast -->
<div class="bg-white rounded-xl shadow-lg p-6 mb-6">
  <h2 class="text-2xl font-bold text-gray-800 mb-4">24-Hour Forecast</h2>
  <div class="overflow-x-auto forecast-scroll">
    <div class="flex space-x-4 pb-4">
      {% for hour in hourly[:24] %}
      <div
        class="weather-card bg-gray-50 rounded-lg p-4 min-w-[120px] text-center"
      >
        <p class="font-semibold text-gray-700">
          {{ format_hour(hour.dt) }}
        </p>
        <img
          src="https://openweathermap.org/img/wn/{{ hour.icon }}.png"
          alt="{{ hour.description }}"
          class="w-16 h-16 mx-auto my-2"
        />
        <p class="text-lg font-bold">{{ hour.temp }}°C</p>
        <div
          class="flex items-center justify-center mt-2 text-sm text-gray-600"
        >
          <i class="fas fa-tint text-blue-500 mr-1"></i>
          {{ hour.pop }}%
        </div>
        {% if hour.rain > 0 %}
        <p class="text-xs text-blue-600 mt-1">{{ hour.rain }}mm</p>
        {% endif %}
      </div>
      {% endfor %}
    </div>
  </div>
</div>

<!-- 7-Day Forecast -->
<div class="bg-white rounded-xl shadow-lg p-6 mb-6">
  <h2 class="text-2xl font-bold text-gray-800 mb-4">7-Day Forecast</h2>
  <div class="grid grid-cols-1 md:grid-cols-7 gap-4">
    {% for day in daily %}
    <div class="weather-card bg-gray-50 rounded-lg p-4 text-center">
      <p class="font-semibold text-gray-700">{{ day.dt.strftime('%a') }}</p>
      <p class="text-sm text-gray-600">{{ day.dt.strftime('%b %d') }}</p>
      <img
        src="https://openweathermap.org/img/wn/{{ day.icon }}.png"
        alt="{{ day.description }}"
        class="w-16 h-16 mx-auto my-2"
      />
      <p class="text-lg font-bold">{{ day.temp_max }}°</p>
      <p class="text-sm text-gray-600">{{ day.temp_min }}°</p>
      <div class="flex items-center justify-center mt-2 text-sm">
        <i class="fas fa-tint text-blue-500 mr-1"></i>
        {{ day.pop }}%
      </div>
      {% if day.rain > 0 %}
      <p class="text-xs text-blue-600 mt-1">{{ day.rain }}mm</p>
      {% endif %}
    </div>
    {% endfor %}
  </div>
</div>

<!-- Charts Section -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
  <!-- Temperature Chart -->
  <div class="bg-white rounded-xl shadow-lg p-6">
    <h3 class="text-xl font-semibold text-gray-800 mb-4">Temperature Trend</h3>
    <canvas id="temperatureChart" class="w-full h-64"></canvas>
  </div>

  <!-- Precipitation Chart -->
  <div class="bg-white rounded-xl shadow-lg p-6">
    <h3 class="text-xl font-semibold text-gray-800 mb-4">
      Precipitation Forecast
    </h3>
    <canvas id="precipitationChart" class="w-full h-64"></canvas>
  </div>
</div>

<!-- Farming Insights -->
<div class="bg-white rounded-xl shadow-lg p-6">
  <h2 class="text-2xl font-bold text-gray-800 mb-4">Farming Insights</h2>
  <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
    <!-- Dynamic insights based on conditions -->
    {% if current.temp > 30 and current.humidity < 40 %}
    <div class="bg-yellow-50 border-l-4 border-yellow-500 rounded-lg p-4">
      <div class="flex items-start">
        <i class="fas fa-exclamation-triangle text-yellow-500 text-xl mr-3"></i>
        <div>
          <h4 class="font-semibold text-yellow-800">Irrigation Recommended</h4>
          <p class="text-yellow-700">
            High temperature and low humidity. Consider irrigating your crops.
          </p>
        </div>
      </div>
    </div>
    {% endif %} 
    
    {% if daily[0].temp_min < 5 %}
    <div class="bg-blue-50 border-l-4 border-blue-500 rounded-lg p-4">
      <div class="flex items-start">
        <i class="fas fa-snowflake text-blue-500 text-xl mr-3"></i>
        <div>
          <h4 class="font-semibold text-blue-800">Frost Warning</h4>
          <p class="text-blue-700">
            Low temperatures expected. Protect sensitive crops from frost.
          </p>
        </div>
      </div>
    </div>
    {% endif %} 
    
    {% for day in daily[:3] %}
      {% if day.pop > 70 %}
      <div class="bg-green-50 border-l-4 border-green-500 rounded-lg p-4">
        <div class="flex items-start">
          <i class="fas fa-cloud-rain text-green-500 text-xl mr-3"></i>
          <div>
            <h4 class="font-semibold text-green-800">Rain Expected</h4>
            <p class="text-green-700">
              {{ day.pop }}% chance of rain on {{ day.dt.strftime('%A') }}.
            </p>
          </div>
        </div>
      </div>
      {% endif %}
    {% endfor %} 
    
    {% if current.wind_speed > 25 %}
    <div class="bg-orange-50 border-l-4 border-orange-500 rounded-lg p-4">
      <div class="flex items-start">
        <i class="fas fa-wind text-orange-500 text-xl mr-3"></i>
        <div>
          <h4 class="font-semibold text-orange-800">Strong Winds</h4>
          <p class="text-orange-700">
            Secure greenhouse covers and support tall crops.
          </p>
        </div>
      </div>
    </div>
    {% endif %}
  </div>
</div>
{% endif %} {% endblock %} {% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  // Wind direction helper
  function getWindDirection(degrees) {
      const directions = ['N', 'NNE', 'NE', 'ENE', 'E', 'ESE', 'SE', 'SSE', 'S', 'SSW', 'SW', 'WSW', 'W', 'WNW', 'NW', 'NNW'];
      const index = Math.round(degrees / 22.5) % 16;
      return directions[index];
  }

  // Search location functions
  function showSearchModal() {
    document.getElementById('searchModal').classList.remove('hidden');
  }

  function closeSearchModal() {
    document.getElementById('searchModal').classList.add('hidden');
  }

  function searchLocation() {
    const location = document.getElementById('locationSearch').value.trim();
    if (location) {
      window.location.href = '/weather/' + encodeURIComponent(location);
    }
  }

  // Add event listener for Enter key in search box
  document.getElementById('locationSearch')?.addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
      searchLocation();
    }
  });

  // Refresh weather data
  async function refreshWeather() {
      const refreshButton = document.querySelector('button[onclick="refreshWeather()"]');
      if (refreshButton) {
          refreshButton.disabled = true;
          refreshButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Refreshing...';
      }
      
      try {
          // Get current location from URL
          const pathParts = window.location.pathname.split('/');
          const location = pathParts[pathParts.length - 1];
          
          const response = await fetch('/weather/api/current/' + location);
          if (!response.ok) {
              throw new Error('Failed to refresh weather data');
          }
          location.reload(); // Simple reload for now
      } catch (error) {
          console.error('Error refreshing weather:', error);
          if (refreshButton) {
              refreshButton.disabled = false;
              refreshButton.innerHTML = '<i class="fas fa-sync-alt mr-2"></i>Refresh';
          }
          alert('Error refreshing weather data. Please try again.');
      }
  }

  // Auto-refresh every 10 minutes
  setInterval(refreshWeather, 600000);

  // Initialize charts
  document.addEventListener('DOMContentLoaded', function() {
      // Only initialize charts if the elements exist and we have weather data
      const tempCanvas = document.getElementById('temperatureChart');
      const precipCanvas = document.getElementById('precipitationChart');
      const hasData = document.querySelector('.weather-gradient');
      
      if (tempCanvas && precipCanvas && hasData) {
          try {
              // Get chart data from server-side JSON 
              const chartData = {{ chart_data_json|safe }};
              
              // Temperature Chart
              const tempCtx = tempCanvas.getContext('2d');
              new Chart(tempCtx, {
                  type: 'line',
                  data: {
                      labels: chartData.hour_labels,
                      datasets: [{
                          label: 'Temperature (°C)',
                          data: chartData.hour_temps,
                          borderColor: '#667eea',
                          backgroundColor: 'rgba(102, 126, 234, 0.1)',
                          borderWidth: 3,
                          tension: 0.4,
                          fill: true
                      }]
                  },
                  options: {
                      responsive: true,
                      maintainAspectRatio: false,
                      plugins: {
                          legend: { display: false }
                      },
                      scales: {
                          y: {
                              beginAtZero: false,
                              grid: { color: 'rgba(0, 0, 0, 0.05)' }
                          }
                      }
                  }
              });

              // Precipitation Chart
              const precipCtx = precipCanvas.getContext('2d');
              new Chart(precipCtx, {
                  type: 'bar',
                  data: {
                      labels: chartData.day_labels,
                      datasets: [{
                          label: 'Rain Probability (%)',
                          data: chartData.day_pops,
                          backgroundColor: '#3b82f6',
                          borderRadius: 6
                      }]
                  },
                  options: {
                      responsive: true,
                      maintainAspectRatio: false,
                      plugins: {
                          legend: { display: false }
                      },
                      scales: {
                          y: {
                              beginAtZero: true,
                              max: 100,
                              grid: { color: 'rgba(0, 0, 0, 0.05)' }
                          }
                      }
                  }
              });
          } catch (error) {
              console.error('Error initializing charts:', error);
          }
      }
  });

  // Jinja2 filter function
  window.wind_direction = function(degrees) {
      return getWindDirection(degrees);
  };
</script>
{% endblock %}