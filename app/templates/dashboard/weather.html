<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Farm Weather Dashboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .weather-card {
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            background: white;
        }
        
        .weather-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1rem;
        }
        
        .weather-icon {
            font-size: 2.5rem;
            margin-right: 1rem;
        }
        
        .temperature {
            font-size: 2.5rem;
            font-weight: bold;
        }
        
        .condition {
            font-size: 1.2rem;
            color: #555;
        }
        
        .weather-details {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
            margin-top: 1.5rem;
        }
        
        .detail-item {
            text-align: center;
            padding: 0.5rem;
        }
        
        .detail-icon {
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
            color: #3498db;
        }
        
        .detail-value {
            font-size: 1.2rem;
            font-weight: bold;
        }
        
        .detail-label {
            font-size: 0.9rem;
            color: #777;
        }
        
        .forecast-card {
            background-color: #f8f9fa;
            padding: 1rem;
            border-radius: 8px;
            margin-top: 1rem;
        }

        .alert {
            padding: 0.75rem 1.25rem;
            margin-bottom: 1rem;
            border: 1px solid transparent;
            border-radius: 0.25rem;
        }
        
        .alert-warning {
            color: #856404;
            background-color: #fff3cd;
            border-color: #ffeeba;
        }
        
        .alert-info {
            color: #0c5460;
            background-color: #d1ecf1;
            border-color: #bee5eb;
        }
        
        .refresh-button {
            padding: 0.375rem 0.75rem;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
        }
        
        .refresh-button:hover {
            background-color: #2980b9;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 2rem;
        }

        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: #3498db;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="weather-dashboard">
            <div class="weather-card">
                <div class="weather-header">
                    <h2>Farm Weather</h2>
                    <button class="refresh-button" id="refreshWeather">
                        <i class="fas fa-sync-alt"></i> Refresh
                    </button>
                </div>
                
                <div id="weatherContent">
                    <div class="weather-main">
                        <div id="weatherIcon" class="weather-icon">
                            <i class="fas fa-cloud"></i>
                        </div>
                        <div>
                            <div id="temperature" class="temperature">-- °C</div>
                            <div id="condition" class="condition">--</div>
                        </div>
                    </div>
                    
                    <div class="weather-details">
                        <div class="detail-item">
                            <div class="detail-icon">
                                <i class="fas fa-tint"></i>
                            </div>
                            <div id="humidity" class="detail-value">--%</div>
                            <div class="detail-label">Humidity</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-icon">
                                <i class="fas fa-cloud-rain"></i>
                            </div>
                            <div id="rainfall" class="detail-value">-- mm</div>
                            <div class="detail-label">Rainfall</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-icon">
                                <i class="fas fa-wind"></i>
                            </div>
                            <div id="windSpeed" class="detail-value">-- m/s</div>
                            <div class="detail-label">Wind Speed</div>
                        </div>
                    </div>
                    
                    <div id="forecastContainer" class="forecast-card">
                        <i class="fas fa-cloud-sun"></i>
                        <span id="forecast">Loading forecast...</span>
                    </div>
                </div>

                <div id="loadingIndicator" class="loading">
                    <div class="spinner"></div>
                    <p>Fetching weather data...</p>
                </div>

                <div id="errorContainer"></div>
            </div>
        </div>
    </div>

    <script>
        // Get farm ID from URL or use a default value
        const urlParams = new URLSearchParams(window.location.search);
        const farmId = urlParams.get('farm_id') || '{{ farm_id }}';
        
        // Weather condition icons mapping
        const weatherIcons = {
            'Clear': '<i class="fas fa-sun" style="color: #f39c12;"></i>',
            'Clouds': '<i class="fas fa-cloud" style="color: #95a5a6;"></i>',
            'Rain': '<i class="fas fa-cloud-rain" style="color: #3498db;"></i>',
            'Drizzle': '<i class="fas fa-cloud-rain" style="color: #3498db;"></i>',
            'Thunderstorm': '<i class="fas fa-bolt" style="color: #f39c12;"></i>',
            'Snow': '<i class="fas fa-snowflake" style="color: #bdc3c7;"></i>',
            'Mist': '<i class="fas fa-smog" style="color: #95a5a6;"></i>',
            'Smoke': '<i class="fas fa-smog" style="color: #95a5a6;"></i>',
            'Haze': '<i class="fas fa-smog" style="color: #95a5a6;"></i>',
            'Dust': '<i class="fas fa-smog" style="color: #d35400;"></i>',
            'Fog': '<i class="fas fa-smog" style="color: #95a5a6;"></i>',
            'Sand': '<i class="fas fa-wind" style="color: #d35400;"></i>',
            'Ash': '<i class="fas fa-smog" style="color: #7f8c8d;"></i>',
            'Squall': '<i class="fas fa-wind" style="color: #7f8c8d;"></i>',
            'Tornado': '<i class="fas fa-wind" style="color: #c0392b;"></i>',
            'Unknown': '<i class="fas fa-question-circle" style="color: #95a5a6;"></i>'
        };

        // Function to fetch weather data
        function fetchWeatherData() {
            // Show loading indicator
            document.getElementById('weatherContent').style.display = 'none';
            document.getElementById('loadingIndicator').style.display = 'block';
            document.getElementById('errorContainer').innerHTML = '';
            
            // API endpoint
            const apiUrl = `/weather-data/${farmId}`;
            
            fetch(apiUrl)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! Status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    // Update the UI with the received data
                    updateWeatherUI(data);
                })
                .catch(error => {
                    console.error('Error fetching weather data:', error);
                    document.getElementById('errorContainer').innerHTML = `
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle"></i> 
                            Unable to fetch weather data. Please try again later.
                        </div>
                    `;
                })
                .finally(() => {
                    // Hide loading indicator
                    document.getElementById('loadingIndicator').style.display = 'none';
                    document.getElementById('weatherContent').style.display = 'block';
                });
        }

        // Function to update UI with weather data
        function updateWeatherUI(data) {
            // Basic weather info
            document.getElementById('temperature').textContent = `${data.temperature} °C`;
            document.getElementById('condition').textContent = data.condition;
            
            // Set weather icon based on condition
            const iconHtml = weatherIcons[data.condition] || weatherIcons['Unknown'];
            document.getElementById('weatherIcon').innerHTML = iconHtml;
            
            // Weather details
            document.getElementById('humidity').textContent = `${data.humidity}%`;
            document.getElementById('rainfall').textContent = `${data.rainfall} mm`;
            document.getElementById('windSpeed').textContent = `${data.wind_speed} m/s`;
            
            // Forecast
            const forecastContainer = document.getElementById('forecastContainer');
            const forecast = document.getElementById('forecast');
            forecast.textContent = data.forecast;
            
            // Style forecast based on content
            if (data.forecast.includes('unavailable') || data.forecast.includes('Set farm location')) {
                forecastContainer.classList.add('alert', 'alert-warning');
            } else if (data.forecast.includes('Rain expected')) {
                forecastContainer.classList.add('alert', 'alert-info');
            } else {
                forecastContainer.classList.remove('alert', 'alert-warning', 'alert-info');
            }
        }

        // Add event listener for refresh button
        document.getElementById('refreshWeather').addEventListener('click', fetchWeatherData);
        
        // Fetch weather data when the page loads
        document.addEventListener('DOMContentLoaded', fetchWeatherData);
    </script>
</body>
</html>